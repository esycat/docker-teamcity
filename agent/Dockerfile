FROM esycat/teamcity-base

MAINTAINER "Eugene Janusov" <esycat@gmail.com>

ENV TEAMCITY_PORT 9090
ENV TEAMCITY_AGENT_DIR ${TEAMCITY_DIR}-agent
ENV TEAMCITY_AGENT_MEM_OPTS -Xmx2g
ENV TEAMCITY_AGENT_PREPARE_SCRIPT=./teamcity-agent.sh

RUN mkdir $TEAMCITY_AGENT_DIR
RUN unzip -d $TEAMCITY_AGENT_DIR $TEAMCITY_DIR/webapps/ROOT/update/buildAgent.zip && \
    chown -R $TEAMCITY_USER:$TEAMCITY_USER $TEAMCITY_AGENT_DIR && \
    chmod +x $TEAMCITY_AGENT_DIR/bin/*.sh
COPY teamcity-agent.sh $TEAMCITY_AGENT_DIR/bin/
RUN rm -rf $TEAMCITY_DIR

WORKDIR $TEAMCITY_AGENT_DIR
USER $TEAMCITY_USER

ENTRYPOINT ["bin/agent.sh"]
CMD ["run"]
EXPOSE $TEAMCITY_PORT
